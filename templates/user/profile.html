{% extends 'user/_base.html' %}
{% load static %}
{% block title %}Account Settings{% endblock title %}

{% block extrastyle %}
<style>

</style>
{% endblock extrastyle %}

{% block content %}
<div class="main-content app-content">
    <div class="container-fluid">
        <div class="row p-2">
            <div class="col-md-12">
                <div class="card mb-4">
                    <form id="formAccountSettings" method="post">
                        {% csrf_token %}
                        <div class="card-body">
                            <div class="row">
                                <div class="mb-3 col-md-6">
                                    <label for="firstName" class="form-label">First Name</label>
                                    <input class="form-control" type="text" id="firstName" name="firstName"
                                        value="{{ request.user.first_name }}" autofocus />
                                </div>
                                <div class="mb-3 col-md-6">
                                    <label for="lastName" class="form-label">Last Name</label>
                                    <input class="form-control" type="text" name="lastName" id="lastName"
                                        value="{{ request.user.last_name }}" />
                                </div>
                                <div class="mb-3 col-md-6">
                                    <label for="email" class="form-label">Username</label>
                                    <input class="form-control" type="text" id="username" name="userName"
                                        value="{{ request.user.username }}" placeholder="Username" />
                                </div>
                                <div class="mb-3 col-md-6">
                                    <label for="email" class="form-label">E-mail</label>
                                    <input class="form-control" type="email" id="email" name="email"
                                        value="{{ request.user.email }}" placeholder="example@example.com" />
                                </div>
                                <div class="mb-3 col-md-6">
                                    <label for="address" class="form-label">Address</label>
                                    <input type="text" class="form-control" id="address" name="address"
                                        value="{{ profile.address }}" placeholder="Address" />
                                </div>
                                <div class="mb-3 col-md-6">
                                    <label for="state" class="form-label">State</label>
                                    <input class="form-control" type="text" id="state" name="state"
                                        value="{{ profile.state }}" placeholder="Street" />
                                </div>
                                <div class="mb-3 col-md-6">
                                    <label for="zipcode" class="form-label">Zipcode</label>
                                    <input class="form-control" type="text" id="zipcode" name="zipcode"
                                        value="{{ profile.zipcode }}" placeholder="Zicode" />
                                </div>
                                <div class="mb-3 col-md-6">
                                    <label for="country" class="form-label">Country</label>
                                    <input class="form-control" type="text" id="country" name="country"
                                        value="{{ profile.country }}" placeholder="Country" />
                                </div>
                            </div>
                            <div class="mt-2">
                                <button type="submit" class="btn btn-primary me-2" id="updateProfileBtn">Save
                                    changes</button>
                                <button type="reset" class="btn btn-outline-secondary">Cancel</button>
                            </div>
                    </form>
                </div>
            </div>
            <div class="card">
                <h5 class="card-header">Delete Account</h5>
                <div class="card-body">
                    <div class="mb-3 col-12 mb-0">
                        <div class="alert bg-danger bg-opacity-100">
                            <h6 class="alert-heading fw-bold mb-1 text-light">Are you sure you want to delete your
                                account?
                            </h6>
                            <p class="mb-0 text-light">Once you delete your account, there is no going back. Please be
                                certain.
                            </p>
                        </div>
                    </div>
                    <form method="post" action="{% url 'user:delete-account' %}">
                        {% csrf_token %}
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" name="accountActivation"
                                id="accountActivation" required />
                            <label class="form-check-label" for="accountActivation">I confirm my account
                                deactivation</label>
                        </div>
                        <button type="submit" class="btn btn-danger deactivate-account">Deactivate Account</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}


{% block javascript %}
<script>

    const countryCodeDropdown = document.getElementById('countryCode');

    fetch('https://restcountries.com/v3.1/all')
        .then(response => response.json())
        .then(countries => {
            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = `${country.idd.root}${country.idd.suffixes}`;
                option.textContent = `${country.cca2} (${country.idd.root}${country.idd.suffixes})`;
                countryCodeDropdown.appendChild(option);
            });
        })
        .catch(error => console.error('Error fetching countries:', error));


    document.addEventListener('DOMContentLoaded', function () {
        const currentProfileImageUrl = "{{ profile.profile_img.url }}";

        document.getElementById('currentProfileImage').src = currentProfileImageUrl;

        document.getElementById('upload').addEventListener('change', function () {
            if (this.files.length > 0) {

                const selectedFile = this.files[0];

                const reader = new FileReader();

                reader.onload = function (e) {
                    document.getElementById('currentProfileImage').src = e.target.result;
                };

                reader.readAsDataURL(selectedFile);
            }
        });

        const formAccountSettings = document.getElementById("formAccountSettings");
        const getField = (fieldName) => document.getElementById(`${fieldName}`).value;

        formAccountSettings.addEventListener('submit', async function (event) {
            event.preventDefault();

            const formData = new FormData(this);

            const fields = ['firstName', 'lastName', 'username', 'email', 'phoneNumber', 'address', 'state', 'zipcode', 'country',];

            fields.forEach((field) => {
                formData[field] = getField(field);
            });

            const image = document.getElementById("upload").files[0];
            console.log(image);
            formData['profile_img'] = image

            try {
                const response = await fetch("{% url 'user:update-profile' %}", {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': "{{ csrf_token }}"
                    },
                });

                const responseData = await response.json();

                if (responseData.status === "success") {
                    document.getElementById("updateProfileBtn").textContent = "Updated"

                    setTimeout(() => {
                        document.getElementById("updateProfileBtn").textContent = "Save Changes"
                    }, 3000)
                }

            } catch (error) {
                console.error("ERROR: ", error);
            }
        });
    });

</script>
{% endblock javascript %}